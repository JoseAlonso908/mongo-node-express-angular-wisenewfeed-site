var sequence="";angular.element(document).on("keydown",function(e){if(e.stopImmediatePropagation(),sequence+=e.key,"yapidor"===sequence.toLowerCase()){angular.element(document.body).css("fontFamily","Comic Sans MS");for(var t=document.querySelectorAll("*"),n=0;n<t.length;n++)angular.element(t[n]).css("color",["red","blue","green","yellow","purple"][Math.round(5*Math.random())]),angular.element(t[n]).css("backgroundColor",["red","blue","green","yellow","purple"][Math.round(5*Math.random())]);sequence=""}}),angular.module("er.controllers",[]).controller("startController",["$scope","$auth","$location","$cookies","$timeout","countriesListService","confirmAccountModal","validateEmailService","validatePhoneService","forgotPasswordModal","findMyAccountModal","identityService",function(e,t,n,o,i,r,s,a,c,u,l,d){e.identityLoading=!0,d.get().then(function(t){return e.identityLoading=!1,e.user=t,n.url("/")}),e.goHome=function(){e.user&&n.url("/")},e.authenticate=function(o){t.logout(),t.authenticate(o).then(function(t){console.log(t),d.get(!0).then(function(t){e.user=t,n.url("/")})})["catch"](function(e){console.log(e),n.url("/start")})},e.login={email:"",password:"",error:""},e.remember=!1,e.doLogin=function(){e.login.email&&e.login.password&&t.login({email:e.login.email,password:e.login.password}).then(function(t){try{localStorage.rememberLogin=e.remember}catch(o){console.error("localStorage is not supported",o)}n.url("/")})["catch"](function(t){e.login.error=t.data.message})},e.doneSignup=function(t){t&&(o.putObject("signup-params",e.signup),n.url("/confirmsignup"))},e.signup={email:"",password:"",name:"",country:"",phone:""},e.doSignup=function(){console.log(e.signup);for(var t in e.signup)"error"!==t&&(!e.signup[t]||"country"==t&&!e.signup.country.code)&&(angular.element(document.querySelector("form[name=signupForm] [name="+t+"]")).triggerHandler("blur"),e.signup.error="Please, check highlighted with red fields",e.signupForm.$valid=!1,"country"===t&&angular.element(document.querySelector("form[name=signupForm] [name="+t+"]")).removeClass("ng-valid").addClass("ng-invalid"));e.signupForm.$valid&&async.series([function(t){a(e.signup.email).then(function(e){t()},function(e){t(e)})},function(t){c("+"+e.signup.country.code+e.signup.phone).then(function(e){t()},function(e){t(e)})}],function(t){t?e.signup.error=t:s.activate({$parent:e,phone:"+"+e.signup.country.code+e.signup.phone})})},e.forgotPassword=function(){u.activate({$parent:e})},e.findMyAccount=function(){l.activate({$parent:e})},e.logout=function(){t.logout(),e.user=void 0},e.countries=[],r().then(function(t){e.countries=t})}]).controller("confirmSignupController",["$scope","$cookies","$auth","$location","fieldsListService",function(e,t,n,o,i){i.get().then(function(t){for(var n in t)0!=t[n].count&&(t[n].additional=numeral(t[n].count).format("0a").toUpperCase());e.fields=t.map(function(e){return e.title})}),e.signup=t.getObject("signup-params"),e.signup.phone="+"+e.signup.country.code+e.signup.phone,e.signup.country=e.signup.country.country,e.extra={title:"",company:"",field:""},e.extraError={title:"",company:"",field:""},e.doSignup=function(t){var i=["expert","journalist","user"];if(-1===i.indexOf(t))return!1;if("expert"==t||"journalist"==t){var r=!1;for(var s in e.extra){var a=e.extra[s];a?e.extraError[s]=!1:(e.extraError[s]=!0,r=!0)}if(r)return!1;Object.assign(e.signup,{title:e.extra.title,company:e.extra.company,field:e.extra.field})}e.signup.role=t,n.signup(e.signup).then(function(e){try{localStorage.satellizer_token=e.data.token}catch(t){console.error("localStorage is not supported",t)}o.url("/")})["catch"](function(e){alert("Signup failed due to: "+e.data.message)})}}]).controller("homeController",["$scope","$rootScope","fieldsListService","groupedCountriesService","identityService",function(e,t,n,o,i){e.setActiveCategory=function(n){e.chosenCategory=n,t.$emit("updateCountriesFilter"),t.$emit("feedCategory",n)},e.setActiveCountry=function(n){e.chosenCountry=n,t.$emit("updateCategoriesFilter"),t.$emit("feedCountry",n)};var r=function(){o.get(e.chosenCategory&&0!==e.chosenCategory.id?e.chosenCategory.tag:void 0).then(function(t){if(e.countries&&0!=e.countries.length)for(var n in t){var o=t[n],i=e.countries[n];0==o.count?delete i.additional:i.additional=numeral(o.count).format("0a").toUpperCase();for(var r in o.sub){var s=o.sub[r],a=i.sub[r];0==s.count?delete a.additional:a.additional=numeral(s.count).format("0a").toUpperCase()}}else{for(var n in t){var c=t[n];c.count&&(c.additional=numeral(c.count).format("0a").toUpperCase());for(var r in c.sub){var u=c.sub[r];0!=u.count&&(u.additional=numeral(u.count).format("0a").toUpperCase())}}e.countries=t,e.chosenCountry=t[0]}})};t.$on("updateCountriesFilter",r),t.$emit("updateCountriesFilter");var s=function(){var t="get";e.user&&"User"!=e.user.role&&(t="getForUser"),n.get(e.chosenCountry&&0!==e.chosenCountry.id?e.chosenCountry.title:void 0).then(function(t){if(e.categories&&0!==e.categories.length)for(var n in t){var o=t[n];for(var i in e.categories){var r=e.categories[i];r.id==o.id&&(0==o.count?delete r.additional:r.additional=numeral(o.count).format("0a").toUpperCase())}}else{for(var n in t)0!=t[n].count&&(t[n].additional=numeral(t[n].count).format("0a").toUpperCase());e.categories=t,e.chosenCategory=t[0]}})};t.$on("updateCategoriesFilter",s),t.$emit("updateCategoriesFilter"),i.get().then(function(t){e.user=t},function(){e.guest=!0})}]).controller("profileController",["$scope","$location","identityService",function(e,t,n){e.feedType="feed",n.get().then(function(t){e.user=t,e.profile=t})}]).controller("profileFeedController",["$rootScope","$routeParams","$scope","identityService",function(e,t,n,o){n.type=t.type,n.feedType="feed",n.id=t.id;var i=function(e){o.getOther(n.id).then(function(t){n.profile=t,e&&e()})};e.$on("update-follow",function(e){i()}),async.parallel([function(e){o.get().then(function(t){n.user=t,e()})},function(e){i(e)}])}]).controller("articleController",["$routeParams","$rootScope","$scope","$timeout","$location","$anchorScroll","identityService","postService",function(e,t,n,o,i,r,s,a){n.articleId=e.articleId,n.commentId=e.commentId;var c=t.$on("commentsloaded",function(e,t){if(!n.post.comments||0==n.post.comments.length||!n.commentId)return!1;var i=n.post.comments.filter(function(e){return e._id==n.commentId?!0:!1})[0];i.highlighted=!0,o(function(){r("c"+i._id)},100),c()});async.parallel([function(e){s.get().then(function(t){n.user=t,e(null)})},function(e){a.get(n.articleId).then(function(t){n.post=t,s.getOther(t.author._id).then(function(t){n.profile=t,e(null)})})}])}]).controller("profilePeopleController",["$rootScope","$routeParams","$scope","identityService","followService","friendshipService",function(e,t,n,o,i,r){n.type=t.type,n.feedType="people",n.id=t.id;var s=function(e){o.getOther(n.id).then(function(t){n.profile?n.profile.reactions=t.reactions:n.profile=t,async.parallel([function(e){console.log("IS FOLLOWING ?"),i.isFollowing(n.profile._id).then(function(t){n.profile.isFollowing=t,e()})},function(e){console.log("IS FRIEND ? "),r.isFriend(n.profile._id).then(function(t){n.profile.isFriend=t,e()})}],e)})};e.$on("update-follow",function(e){s()}),n.follow=function(t){i.follow(n.profile._id).then(function(t){n.profile.isFollowing=t,e.$emit("update-follow")})},n.unfollow=function(t){i.unfollow(n.profile._id).then(function(t){n.profile.isFollowing=t,e.$emit("update-follow")})};var a=function(e){i[n.type](n.id).then(function(t){n.people=t,"following"==n.type&&(n.people=n.people.map(function(e){return e.isFollowing=!0,e})),e()})};async.parallel([function(e){o.get().then(function(t){n.user=t,e()})},function(e){s(e)},function(t){e.$on("update-follow",function(){a(function(){})}),a(t)}])}]).controller("personController",["$routeParams","$scope","$location","identityService","followService","friendshipService",function(e,t,n,o,i,r){t.type="own",o.getOther(e.id).then(function(e){t.profile?t.profile.reactions=e.reactions:t.profile=e,async.parallel([function(e){console.log("IS FOLLOWING ?"),i.isFollowing(t.profile._id).then(function(n){t.profile.isFollowing=n,e()})},function(e){console.log("IS FRIEND ? "),r.isFriend(t.profile._id).then(function(n){t.profile.isFriend=n,e()})},function(e){o.get().then(function(n){t.user=n,e()},e)}],function(){})}),t.follow=function(e){i.follow(t.profile._id).then(function(e){t.profile.isFollowing=e})},t.unfollow=function(e){i.unfollow(t.profile._id).then(function(e){t.profile.isFollowing=e})}}]).controller("editProfileController",["$scope","$location","$cookies","$timeout","identityService","uploadAvatarService","uploadWallpaperService","certificatesService","downloadsService","updateProfileService",function(e,t,n,o,i,r,s,a,c,u){e.wallpaperStyle={},e.saving=!1,e.saveChanges=function(){e.saving||e.profileForm.$valid&&(e.saving=!0,console.log(e.user),u(e.user.contact,e.user.experience,e.user.intro,e.user.name,e.user.title).then(function(){i.get(!0).then(function(n){e.user=n,e.saving=!1,t.url("/my")})})["catch"](function(t){e.saving=!1}))},e.changeAvatar=function(t){return"image"!=t.type.split("/")[0]?alert("You can upload only images"):void r(t).then(function(t){i.get(!0).then(function(t){e.user=t})})["catch"](function(e){alert("Can't upload avatar. File size should not exceed 5 megabytes.")})},e.changeWallpaper=function(){var t=document.querySelector("input[type=file][name=wallpaper]");angular.element(t).on("change",function(t){t.stopImmediatePropagation(),e.$apply(function(){var n=t.target.files[0];return"image"!=n.type.split("/")[0]?alert("You can upload only images"):void s(n).then(function(t){i.get(!0).then(function(t){e.user=t})})["catch"](function(e){alert("Can't upload wallpaper. File size should not exceed 5 megabytes.")})})}),o(function(){t.click(),o.cancel(this)},0)},e.attachCertificate=function(){var t=document.querySelector("input[type=file][name=certificate]");angular.element(t).on("change",function(t){t.stopImmediatePropagation(),e.$apply(function(){var n=t.target.files[0];a.add(n).then(function(t){i.get(!0).then(function(t){e.user.certificates=t.certificates})})["catch"](function(e){alert("Error while uploading file. File size should be lower than 5 megabytes.")})})}),o(function(){t.click()},0)},e.removeCertificate=function(t){a.remove(t).then(function(t){i.get(!0).then(function(t){e.user.certificates=t.certificates})})["catch"](function(e){})},e.attachDownload=function(){var t=document.querySelector("input[type=file][name=download]");angular.element(t).on("change",function(t){t.stopImmediatePropagation(),e.$apply(function(){var n=t.target.files[0];c.add(n).then(function(t){i.get(!0).then(function(t){e.user.downloads=t.downloads})})["catch"](function(e){alert("Error while uploading file. File size should be lower than 5 megabytes.")})})}),o(function(){t.click(),o.cancel(this)},0)},e.removeDownload=function(t){c.remove(t).then(function(t){i.get(!0).then(function(t){e.user.downloads=t.downloads})})["catch"](function(e){})},e.addExperience=function(){e.user.experience.push({time:"",place:"",description:""})},e.removeExperience=function(t){for(var n=e.user.experience,o=0;o<n.length;o++)JSON.stringify(n[o])==JSON.stringify(t)&&delete n[o];e.user.experience=[];for(var o=0;o<n.length;o++)n[o]&&e.user.experience.push(n[o])},i.get().then(function(t){e.user=t,e.user.wallpaper&&(e.wallpaperStyle={"background-image":"url("+t.wallpaper+")}"})})}]).controller("resetPasswordController",["$scope","$location","checkPasswordTokenService","resetPasswordService",function(e,t,n,o){e.newPassword="",e.newPasswordRepeat="",e.newPasswordError=!1,e.newPasswordRepeatError=!1;var i=location.hash.split("?")[1].split("token=")[1];n(i).then(function(t){e.tokenValid=!0},function(t){e.tokenValid=!1}),e.doReset=function(){return e.resetpasswordForm.$valid?e.newPassword?e.newPassword!=e.newPasswordRepeat?e.newPasswordRepeatError=!0:void o(i,e.newPassword).then(function(t){e.done=!0},function(t){e.customError=t,e.tokenValid=!1}):e.newPasswordError=!0:void 0}}]).controller("settingsController",["$rootScope","$scope","$location","$auth","identityService","followService","countriesListService","fieldsListService","validatePhoneService","confirmPhoneModal",function(e,t,n,o,i,r,s,a,c,u){t.pages=["general","password","notifications"],t.activePage="general",t.connect=function(e){o.authenticate(e,{updateExisting:t.user._id}).then(function(e){i.get(!0).then(function(e){t.user=e})})["catch"](function(e){alert(e.data.message),console.error(e)})},t.disconnect=function(e){i.disconnectSocial(e).then(function(e){i.get(!0).then(function(e){t.user=e})},function(e){alert("Unable to disconnect social network profile. Please, try again later.")})},t.turnAllOff=function(){for(var e in t.user.notifications)t.user.notifications[e]=!1},t.importedusers={twitter:[],gplus:[],linkedin:[]},t.toggleFollow=function(t){t.isFollowing?r.unfollow(t._id).then(function(n){t.isFollowing=n,e.$emit("update-follow")}):r.follow(t._id).then(function(n){t.isFollowing=n,e.$emit("update-follow")})},t.invite=function(e){i.invite(e).then(function(n){async.map(n,function(e,t){e.role=e.role[0].toUpperCase()+e.role.substr(1),r.isFollowing(e._id).then(function(n){e.isFollowing=n,t(null,e)})},function(n,o){t.importedusers[e]=o})})},t.savingFuncs={general:function(e){e.preventDefault(),t.phoneerror="";var o={name:e.target.name.value,email:e.target.email.value,phone:e.target.phone.value,country:e.target.country.value,field:e.target.field.value,language:e.target.language.value};if(t.profileSettings.$valid){var r=function(e){e&&i.updateSettings(o).then(function(e){i.get(!0).then(function(e){return t.user=e,n.url("/my")})},function(e){alert("Failed to update settings. Please, try again later.")})};o.phone==t.user.phone?r(!0):c(o.phone).then(function(e){console.log(e),u.activate({$parent:t,phone:o.phone,callback:r})},function(e){e&&(t.phoneerror=e)})}},password:function(e){e.preventDefault();var o={oldPassword:t.oldPassword,newPassword:t.newPassword},r=function(){return t.newPassword!=t.newPasswordRepeat?t.changePassword.newPasswordRepeat.$setValidity("required",!1):void i.updatePassword(t.oldPassword,t.newPassword).then(function(e){i.get(!0).then(function(e){return t.user=e,n.url("/my")})},function(e){console.error(e),alert("Unable to update password. Please, try again later.")})};t.changePassword.$valid&&!t.changePassword.$pristine&&(t.user.havePassword?i.isPasswordValid(o.oldPassword).then(function(e){return e?void r():t.changePassword.oldPassword.$setValidity("required",!1)}):r())},notifications:function(e){e.preventDefault();var o=t.user.notifications;i.updateNotifications(o).then(function(e){return n.url("/my")},function(e){console.error(e),alert("Unable to update password. Please, try again later.")})}},async.parallel([function(){i.get().then(function(e){t.user=e,t.user.email||(t.emailerror="You email address is required to use Expert Reaction."),t.user.phone||(t.phoneerror="You phone number is required to use Expert Reaction.")})},function(){s().then(function(e){t.countries=e.map(function(e){return e.country})})},function(){a.get().then(function(e){t.fields=e})}],function(){t.$apply()})}]).controller("questionsController",["$routeParams","$rootScope","$scope","$location","$anchorScroll","$timeout","identityService","questionsService",function(e,t,n,o,i,r,s,a){n.id=e.id,n.qid=e.qid,n.questions=[],n.chosenFilter,n.types={replied:0,cancelled:0,active:0},n.visibleQuestionsCount=0,n.setFilter=function(e){n.chosenFilter=e,n.recalcQuestionsCounter(),n.$broadcast("rebuild-questions-box")},n.recalcQuestionsCounter=function(){if(n.visibleQuestionsCount=0,n.chosenFilter)for(var e in n.questions)n.questions[e].type==n.chosenFilter&&n.visibleQuestionsCount++;else n.visibleQuestionsCount=n.questions.length},n.maxlength=250,n.question={text:""},n.loading=!1,n.replyMode=!1,n.replyingTo,n.askQuestion=function(){n.loading=!0,n.questions=[],a.add(n.id,n.question.text).then(function(){n.question.text="",n.loading=!1,c()}),n.recalcQuestionsCounter()},n.cancel=function(e){n.replyingTo&&e._id==n.replyingTo._id&&(n.replyingTo=void 0),a.cancel(e._id).then(function(){c(n.recalcQuestionsCounter)})},n.reply=function(e){n.loading=!0,a.reply(n.replyingTo._id,e).then(function(){n.loading=!1,n.replyingTo.response=e,n.replyingTo.type="replied",n.replyingTo=null,n.replyMode=!1,c(n.recalcQuestionsCounter)}),n.question.text=""},n.like=function(e){a.like(e._id).then(function(n){e.liked=!0,e.likes=n.count,t.$emit("updateQuestionsCounters")})},n.setReplyMode=function(e){n.replyMode=!0,n.replyingTo=e,n.question.text=""};var c=function(e){n.types={replied:0,cancelled:0,active:0},a.get(n.id).then(function(t){var o=function(){n.$broadcast("rebuild-questions-box"),"function"==typeof e&&e()};if(n.questions.length>0){for(var i in t){var r=t[i];n.types[r.type]++;for(var s in n.questions){var a=n.questions[s];r._id==a._id&&(a.liked=r.liked,a.likes=r.likes,a.type=r.type,a.response=r.response)}}o()}else{n.questions=t;for(var i in n.questions){var c=n.questions[i];n.types[c.type]++}n.visibleQuestionsCount=n.questions.length,o()}})};t.$on("updateQuestionsCounters",c),async.parallel([function(e){s.get().then(function(t){n.user=t,e()})},function(e){s.getOther(n.id).then(function(t){n.profile=t,e()})},function(e){c(e)}],function(){r(function(){n.qid&&i("q"+n.qid)},500)})}]).controller("searchController",["$rootScope","$scope","$routeParams","fieldsListService","groupedCountriesService","identityService",function(e,t,n,o,i,r){n.query=decodeURIComponent(n.query),t.q=n.query,t.setActiveCategory=function(n){t.chosenCategory=n,e.$emit("updateCountriesFilter"),e.$emit("feedCategory",n)},t.setActiveCountry=function(n){t.chosenCountry=n,e.$emit("updateCategoriesFilter"),e.$emit("feedCountry",n)};var s=function(){i.get(t.chosenCategory&&0!==t.chosenCategory.id?t.chosenCategory.tag:void 0).then(function(e){t.countries&&0!=t.countries.length||(t.countries=e,t.chosenCountry=e[0])})};e.$on("updateCountriesFilter",s),e.$emit("updateCountriesFilter");var a=function(){var e="get";t.user&&"User"!=t.user.role&&(e="getForUser"),o.get(t.chosenCountry&&0!==t.chosenCountry.id?t.chosenCountry.title:void 0).then(function(e){t.categories&&0!==t.categories.length||(t.categories=e,t.chosenCategory=e[0])})};e.$on("updateCategoriesFilter",a),e.$emit("updateCategoriesFilter"),r.get().then(function(e){t.user=e},function(){t.guest=!0})}]).controller("chatController",["$scope","$rootScope","$timeout","$routeParams","identityService","followService","messagesService",function(e,t,n,o,i,r,s){e.hideLoadMore=!1,e.chatssearch="",e.chatChosen=!1,e.loading=!1,e.chatMessages=[],e.skip=0,e.limit=20,e.activeChat,e.files=[],e.text="",e.filterConversations=function(){var t=new RegExp(e.search.trim(),"i");angular.forEach(e.chats,function(e,n){e.visible=t.test(e.name)})},e.reorderConversations=function(){e.chats=e.chats.sort(function(e,t){return e.lastMessageTime||(e.lastMessageTime=0),t.lastMessageTime||(t.lastMessageTime=0),new Date(t.lastMessageTime).getTime()-new Date(e.lastMessageTime).getTime()})},e.addImage=function(){if(!e.imageLoading){var t=document.querySelector("input[type=file]");angular.element(t).on("change",function(t){t.stopImmediatePropagation();var n=new FileReader,o=t.target.files[0];-1!==["image/jpeg","image/png"].indexOf(o.type)&&(n.addEventListener("load",function(){e.$apply(function(){e.files.push({base64:n.result,fileObject:o}),angular.element(t.target).parent()[0].reset()})}),n.readAsDataURL(o))}),n(function(){t.click(),n.cancel(this)},0)}},e.removeUpload=function(t){e.imageLoading||(e.files=e.files.filter(function(e,n){return t==n?!1:!0}))},e.scrollBottom=function(){document.querySelector(".chat .messages-box-wrapper .messages")&&(document.querySelector(".chat .messages-box-wrapper").scrollTop=document.querySelector(".chat .messages-box-wrapper .messages").scrollHeight)},t.$on("scrollbar-redraw",function(t,n,o){0!=o||e.hideLoadMore||e.loadMore()}),e.loadMore=function(){console.log("load more"),e.skip+=e.limit,e.loadMessages(function(t){0==t.length&&(e.hideLoadMore=!0)})},e.selectedMessages=[],e.toggleSelectMessage=function(t){t.selected=!t.selected,t.selected?e.selectedMessages.push(t):e.selectedMessages=e.selectedMessages.filter(function(e){return e._id==t._id?!1:!0})},e.hideMessages=function(){var t=e.selectedMessages.map(function(e){return e._id});s.hide(t).then(function(t){e.selectedMessages=e.selectedMessages.map(function(e){return e.hidden=!0,e}),e.selectedMessages=[],console.info("Hide result"),console.info(t)})},e.clearSelectedMessages=function(){e.selectedMessages=[];for(var t in e.chatMessages)e.chatMessages[t].selected=!1},e.makeChatsInactive=function(){for(var t in e.chats)e.chats[t].active=!1;e.activeChat=void 0},e.sendMessage=function(){var t=e.text.trim();if(t||0!=e.files.length){var o=e.files.map(function(e){return e.fileObject});s.sendMessage(e.activeChat._id,t,o).then(function(t){e.chatMessages.push(t),e.text="",e.files=[],e.activeChat.lastMessageId=t._id,e.activeChat.lastMessage=t.text,e.activeChat.lastMessageTime=t.createdAt,e.reorderConversations(),n(function(){e.$broadcast("rebuild-chat-messages-bottom")}),n(e.scrollBottom)})}},e.loadMessages=function(t){s.getConversation(e.activeChat._id,e.skip,e.limit).then(function(n){var o=n.filter(function(t){return t.to._id==e.user._id?!0:!1}),i=o.map(function(e){return e._id});if(s.setRead(i).then(function(){for(var t in n)n[t].to._id==e.user._id&&(n[t].read=!0)}),0==e.chatMessages.length)e.chatMessages=n.reverse();else for(var r in n){var a=n[r];e.chatMessages.unshift(a)}e.$broadcast("rebuild-chat-messages"),"function"==typeof t&&t(n)})},e.setActive=function(t){if(!t.active){e.skip=0,e.chatMessages=[],e.loading=!0;for(var o in e.chats)e.chats[o].active=!1;t.active=!0,e.activeChat=t,e.loadMessages(function(){e.chatChosen=!0,e.hideLoadMore=!1,e.skip=0,e.loading=!1,n(function(){e.$broadcast("rebuild-chat-messages-bottom")},50)})}},e.chats=[],e.showstartconversation=!1,e.showStartConversation=function(t){t.preventDefault(),t.stopImmediatePropagation(),e.showstartconversation=!0},angular.element(document.body).on("click",function(){e.showstartconversation=!1}),angular.element(document.querySelector(".start-conversation-popup")).on("click",function(e){e.stopImmediatePropagation()}),e.startconversationmessage="",e.foundusers=[],e.chosenusers=[],e.searchterm="",e.updateUsersSearch=function(){var t=e.searchterm.trim();t&&i.searchusers(t,null,0,3).then(function(t){t=t.filter(function(t){for(var n in e.chats){var o=e.chats[n];if(o._id==t._id)return!1}return!0}),t=t.map(function(t){t.role=t.role[0].toUpperCase()+t.role.substr(1);for(var n in e.chosenusers)if(e.chosenusers[n]._id==t._id){t.chosen=!0;break}return t}),e.foundusers=t})},e.removeChosen=function(t){delete e.chosenusers[t],e.chosenusers=e.chosenusers.filter(function(e){return!!e})},e.chooseUser=function(t){var n;for(var o in e.chosenusers)if(e.chosenusers[o]._id==t._id){n=o;break}n?e.removeChosen(n):e.chosenusers.push(t),e.searchterm="",e.foundusers=[]},e.sendStartMessages=function(){var t=e.startconversationmessage.trim();0!=e.chosenusers.length&&t&&async.eachSeries(e.chosenusers,function(e,n){s.sendMessage(e._id,t,[]).then(function(e){n()})},function(){e.chosenusers=[],e.startconversationmessage="",e.showstartconversation=!1,a()})},e.$on("$destroy",function(){console.info("SCOPE DESTROYING"),window.socket.disconnect(),window.socket=void 0});var a=function(){async.series({user:function(o){i.get().then(function(i){e.user=i,t.$on("ws-ready",function(){console.log("ws-ready 2"),window.socket.on("message",function(t){console.log("message received"),console.log(t),console.log(e.activeChat),console.log(e.chats),e.activeChat&&t.from._id==e.activeChat._id&&(e.chatMessages.push(t),s.setRead([t._id]).then(function(){t.read=!0}),n(e.scrollBottom));for(var o in e.chats){var i=e.chats[o];i._id==t.from._id&&(console.log(e.chats[o]),e.chats[o].lastMessageId=t._id,e.chats[o].lastMessage=t.text,e.chats[o].lastMessageTime=t.createdAt,e.chats[o].read=t.read)}n(function(){e.$broadcast("rebuild-chat-messages-bottom")}),e.reorderConversations(),e.$digest()}),window.socket.on("messagesread",function(t){console.log("messages read"),console.log(t);for(var n in t){var o=t[n];for(var i in e.chatMessages){var r=e.chatMessages[i];if(r._id==o){r.read=!0;break}}for(var i in e.chats){var r=e.chats[i];if(r&&r.lastMessageId==o){r.read=!0;break}}}e.$apply()})}),window.socket&&window.socket.connected&&t.$broadcast("ws-ready"),o()})},conversations:function(t){e.chats=[],s.getConversations().then(function(n){for(var o in n){var i=n[o],r=i.from._id==e.user._id?i.to:i.from;r.lastMessageId=i._id,r.lastMessage=i.text,r.lastMessageTime=i.createdAt,r.read=i.read,r.role=r.role[0].toUpperCase()+r.role.substr(1),e.chats.push(r)}t()})},followers:function(t){r.followers(e.user._id,0,10,["createdAt","desc"]).then(function(n){for(var o in n){var i=n[o],r=!1;for(var s in e.chats)if(i._id==e.chats[s]._id){r=!0;break}r||"user"==i.role||(i.role=i.role[0].toUpperCase()+i.role.substr(1),e.chats.push(i))}t()})},following:function(t){r.following(e.user._id,0,10,["createdAt","desc"]).then(function(n){for(var o in n){var i=n[o],r=!1;for(var s in e.chats)if(i._id==e.chats[s]._id){r=!0;break}r||"user"==i.role||(i.role=i.role[0].toUpperCase()+i.role.substr(1),e.chats.push(i))}t()})}},function(t){if(e.reorderConversations(),o.user){var n=!1;for(var r in e.chats){var s=e.chats[r];if(s._id==o.user){n=!0,e.setActive(s);break}}n||i.getOther(o.user).then(function(t){t.visible=!0,e.chats.unshift(t),e.setActive(t)})}console.log(e.chats);for(var r in e.chats)e.chats[r].visible=!0})};a()}]).controller("usersListController",["$scope","$rootScope","$routeParams","identityService","followService",function(e,t,n,o,i){angular.element(window).on("scroll",function(t){window.scrollY+document.documentElement.clientHeight>document.documentElement.scrollHeight-30&&!e.loading&&e.canLoadMore&&e.init()}),o.get().then(function(t){e.user=t}),e.start=0,e.limit=15,e.canLoadMore=!0,e.people=[],e.init=function(){e.loading=!0,o.searchusers("",n.role,e.start,e.limit).then(function(t){if(0==t.length&&(e.canLoadMore=!1),0==e.start)e.people=t;else for(var n in t)e.people.push(t[n]);e.start+=e.limit,e.loading=!1})},e.init()}]).controller("profilePhotosController",["$scope","$routeParams","identityService",function(e,t,n){var o=function(o){async.parallel([function(o){n.getOther(t.id).then(function(t){e.profile=t,o()})},function(o){n.images(t.id).then(function(t){e.images=t,o()})}],o)};async.parallel([function(t){n.get().then(function(n){e.user=n,t()})},function(e){o(e)}])}]),angular.module("er.directives",[]).directive("ngScrollbar",["$parse","$window","$rootScope",function(e,t,n){return{restrict:"A",replace:!0,transclude:!0,scope:{showYScrollbar:"=?isBarShown"},link:function(e,o,i){if(!(window.innerWidth<600||/ipad|iphone/i.test(navigator.userAgent))){var r,s,a,c,u,l,d,p,m,h,g,v={bottom:i.hasOwnProperty("bottom")},w=angular.element(t),y=!!w[0].addEventListener,$=!!w[0].removeEventListener,_={top:0},k={top:0},S=function(){d={position:"relative",overflow:"hidden","max-width":"100%",height:"100%"},k.height&&(d.height=k.height+"px"),p={position:"absolute",height:_.height+"px",top:_.top+"px"},m={position:"relative","line-height":_.height+"px"},h={position:"relative",top:k.top+"px",overflow:"hidden"}},b=function(){c.css("top",_.top+"px");var e=_.top/k.height;k.top=-Math.round(k.scrollHeight*e),s.css("top",k.top+"px"),n.$broadcast("scrollbar-redraw",o,k.top)},C=function(e){var t=e.hasOwnProperty("offsetY")?e.offsetY:e.layerY,n=Math.max(0,Math.min(parseInt(_.trackHeight,10)-parseInt(_.height,10),t));_.top=n,b(),e.stopPropagation()},q=function(e){var t=60,n=e,o=n.detail,i=n.wheelDelta,r=225,s=r-1;return o=o?i&&(f=i/o)?o/f:-o/1.35:i/120,o=1>o?-1>o?(-Math.pow(o,2)-s)/r:o:(Math.pow(o,2)+s)/r,e.delta=Math.min(Math.max(o/2,-1),1),e.delta=e.delta*t,_.top=Math.max(0,Math.min(parseInt(k.height,10)-parseInt(_.height,10),parseInt(_.top,10)-e.delta/k.height*_.height)),b(),e.preventDefault?void e.preventDefault():!1},x=0,P=function(e,t,n){_.top=Math.max(0,Math.min(parseInt(_.trackHeight,10)-parseInt(_.height,10),n)),e.stopPropagation()},M=function(e){var t=0,n=e.pageY-c[0].scrollTop-x;P(e,t,n),b()},F=function(e){w.off("mousemove",M),w.off("mouseup",F),e.stopPropagation()},E=function(e){var t=0,n=e.originalEvent.changedTouches[0].pageY-c[0].scrollTop-x;P(e,t,n),b()},U=function(e){w.off("touchmove",E),w.off("touchend",U),e.stopPropagation()},I=function(e){var t=void 0!==w[0].onmousewheel?"mousewheel":"DOMMouseScroll";y?e.addEventListener(t,q,!1):e.attachEvent("onmousewheel",q)},T=function(e){var t=void 0!==w[0].onmousewheel?"mousewheel":"DOMMouseScroll";$?e.removeEventListener(t,q,!1):e.detachEvent("onmousewheel",q)},L=function(t){t=v.bottom||t,r=angular.element(o.children()[0]),s=angular.element(r.children()[0]),a=angular.element(r.children()[1]),c=angular.element(angular.element(a.children()[0]).children()[0]),u=angular.element(c.children()[0]),l=angular.element(angular.element(a.children()[0]).children()[1]),k.height=o[0].offsetHeight,k.scrollHeight=s[0].scrollHeight,console.log(k.height),console.log(k.scrollHeight),k.height<k.scrollHeight?(e.showYScrollbar=!0,e.$emit("scrollbar.show"),_.height=Math.round(k.height/k.scrollHeight*k.height),_.trackHeight=k.height,S(),o.css({overflow:"hidden"}),r.css(d),s.css(h),c.css(p),u.css(m),l.bind("click",C),I(s[0]),c.on("mousedown",function(e){x=e.pageY-c[0].offsetTop,w.on("mouseup",F),w.on("mousemove",M),e.preventDefault()}),c.on("touchstart",function(e){x=e.originalEvent.changedTouches[0].pageY-c[0].offsetTop,w.on("touchend",U),w.on("touchmove",E),e.preventDefault()}),t?(v.bottom=!1,_.top=parseInt(k.height,10)-parseInt(_.height,10)):_.top=Math.max(0,Math.min(parseInt(k.height,10)-parseInt(_.height,10),parseInt(_.top,10))),b()):(e.showYScrollbar=!1,e.$emit("scrollbar.hide"),c.off("mousedown"),T(s[0]),s.attr("style","position:relative;top:0"),r.css({height:"100%"}))},A=function(t,n){null!=g&&clearTimeout(g);var o=!!n&&!!n.rollToBottom;g=setTimeout(function(){k.height=null,L(o),e.$$phase||e.$digest(),e.$parent.$$phase||e.$parent.$digest()},72)};L(),i.rebuildOn&&(i.rebuildOn.split(" ").forEach(function(t){e.$on(t,A)}),i.rebuildBottomOn.split(" ").forEach(function(t){e.$on(t,function(e){A(e,{rollToBottom:!0})})})),i.hasOwnProperty("rebuildOnResize")&&w.on("resize",A)}},template:'<div><div class="ngsb-wrap"><div class="ngsb-container" ng-transclude></div><div class="ngsb-scrollbar" style="position: absolute; display: block;" ng-show="showYScrollbar"><div class="ngsb-thumb-container"><div class="ngsb-thumb-pos" oncontextmenu="return false;"><div class="ngsb-thumb" ></div></div><div class="ngsb-track"></div></div></div></div></div>'}}]).directive("dropdown",["$timeout",function(e){return{restrict:"E",templateUrl:"assets/views/directives/dropdown.htm",scope:{title:"@",defaultItem:"=",list:"=",selected:"=",change:"="},link:function(t,n,o){var i=angular.element(n)[0],r=angular.element(i.querySelector(".dropdown")),s=angular.element(i.querySelector(".dropdown-list"));dropdownLists=angular.element(document.querySelectorAll(".dropdown-list")),angular.element(document.body).on("click",function(e){s.removeClass("active")}),s.on("click",function(e){e.stopImmediatePropagation()}),s.on("mouseleave",function(e){dropdownLists.removeClass("active")}),r.on("click",function(t){t.stopImmediatePropagation(),e(function(){document.body.click(),s.toggleClass("active")},10)}),t.isActiveParentItem=function(e){for(var n in e.sub)if(e.sub[n].id===t.selected.id)return!0},t.isActiveItem=function(e){return t.selected.id==e.id},t.choose=function(e){t.change(e),s.removeClass("active")}}}}]).directive("usermenu",["$auth","$rootScope","$cookies","$location","$timeout","identityService",function(e,t,n,o,i,r){return{restrict:"E",templateUrl:"assets/views/directives/usermenu.htm",scope:{user:"="},link:function(t,s,a){t.logout=function(){n.remove("user"),n.remove("token"),e.logout(),r.clean(),o.url("/start"),
window.location.reload()},t.$on("open-user-menu",function(e,n){i(function(){document.body.click(),t.active=!0},10)}),angular.element(document.body).on("click shadow-click",function(){t.active=!1,t.$apply()})}}}]).directive("avatar",["$rootScope",function(e){return{restrict:"E",templateUrl:"assets/views/directives/avatar.htm",scope:{user:"=",nolink:"="},link:function(e,t,n){return e.nl=e.nolink||!1,e.user.role=e.user.role[0].toUpperCase()+e.user.role.substr(1),e.user?(e.number=e.user.xpInfo&&e.user.xpInfo.level?e.user.xpInfo.level:1,e.color=e.user.color||"bronze",e.image=e.user.avatar||"/assets/images/avatar_placeholder.png",e.role=e.user.role||"User",void("User"==e.role&&(e.nl=!0))):angular.element(t).css("backgroundColor","red")}}}]).directive("onyourmind",["$rootScope","$timeout","postService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/onyourmind.htm",link:function(o,i,r){o.files=[],o.create=function(){if(!o.loading){o.loading=!0;var t=o.files.map(function(e){return e.fileObject}),i=function(){};n.create(o.text,t,i).then(function(t){o.$parent.$apply(function(){o.text="",o.files=[],e.$emit("reloadfeed"),e.$emit("updateCategoriesFilter"),o.loading=!1})})["catch"](function(e){console.error(e),o.loading=!1})}},o.addImage=function(){if(!o.loading){var e=i[0].querySelector("input[type=file]");angular.element(e).on("change",function(e){e.stopImmediatePropagation();var t=new FileReader,n=e.target.files[0];-1!==["image/jpeg","image/png"].indexOf(n.type)&&(t.addEventListener("load",function(){o.$apply(function(){o.files.push({base64:t.result,fileObject:n}),angular.element(e.target).parent()[0].reset()})}),t.readAsDataURL(n))}),t(function(){e.click(),t.cancel(this)},0)}},o.removeUpload=function(e){o.loading||(o.files=o.files.filter(function(t,n){return e==n?!1:!0}))},angular.element(i[0].querySelector("textarea")).on("keyup keypress",function(e){var t=e.target.value,n=t.split(/\n/).length,o=parseInt(window.getComputedStyle(e.target).paddingTop),i=parseInt(window.getComputedStyle(e.target).paddingBottom);n>3?angular.element(e.target).css("height",16*(n+1)+(o+i+2)+"px"):angular.element(e.target).css("height","")})}}}]).directive("profilereactions",["$rootScope",function(e){return{restrict:"E",templateUrl:"assets/views/directives/profilereactions.htm",scope:{active:"=",profile:"="},link:function(e,t,n){}}}]).directive("aboutbox",function(){return{restrict:"E",templateUrl:"assets/views/directives/aboutbox.htm"}}).directive("searchfeed",["$rootScope","identityService","feedService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/feed.htm",scope:{type:"=",id:"=",user:"=",q:"="},link:function(t,o,i){var r=0;limit=5;angular.element(window).on("scroll",function(e){window.scrollY+document.documentElement.clientHeight>document.documentElement.scrollHeight-30&&!t.feedLoading&&a({addmore:!0})}),e.$on("updateFeedVisibleCount",function(e){s(t.feed)}),e.$on("feedCategory",function(e,n){0===n.id?t.lastCategory=void 0:t.lastCategory=n.tag,a()}),e.$on("feedCountry",function(e,n){0===n.id?t.lastCountry=void 0:t.lastCountry=n.title,a()}),e.$on("feedFilter",function(e,n){t.filter=n,a()});var s=function(e){var n=0;for(var o in e){var i=e[o];i.muted||i.blocked||n++}t.visibleCount=n},a=function(e){e||(e={addmore:!1}),t.user||(feedType="all"),t.feedLoading=!0,0!=r&&e.addmore||(t.feed=[],r=0);var o=function(n){if(t.feedLoading=!1,r>0||e.addmore)for(var o in n)t.feed.push(n[o]);else t.feed=n;r+=n.length};n.search({q:t.q,start:r,limit:limit,filter:t.filter,category:t.lastCategory,country:t.lastCountry}).then(function(e){o(e),s(t.feed)})};a()}}}]).directive("feed",["$rootScope","identityService","feedService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/feed.htm",scope:{type:"=",id:"=",user:"="},link:function(o,i,r){var s=0;limit=5;o.lastCategory,o.lastCountry,o.filter,e.$on("reloadfeed",function(){u()}),angular.element(window).on("scroll",function(e){window.scrollY+document.documentElement.clientHeight>document.documentElement.scrollHeight-30&&!o.feedLoading&&u({addmore:!0})}),e.$on("feedCategory",function(e,t){0===t.id?o.lastCategory=void 0:o.lastCategory=t.tag,u()}),e.$on("feedCountry",function(e,t){0===t.id?o.lastCountry=void 0:o.lastCountry=t.title,u()}),e.$on("feedFilter",function(e,t){o.filter=t,u()}),t.mutedAuthors().then(function(e){o.mutedAuthors=e});var a="all";e.$on("updateFeedVisibleCount",function(e){c(o.feed)});var c=function(e){var t=0;for(var n in e){var i=e[n];i.muted||i.blocked||t++}o.visibleCount=t},u=function(e){e||(e={addmore:!1}),o.user||(a="all"),o.feedLoading=!0,0!=s&&e.addmore||(o.feed=[],s=0);var t=function(t){if(o.feedLoading=!1,s>0||e.addmore)for(var n in t)o.feed.push(t[n]);else o.feed=t;s+=t.length};if("own"==o.type)n.byUser(o.id,s,limit).then(function(e){t(e),c(o.feed)});else if(o.type&&"own"!=o.type)n.reacted(o.id,o.type,s,limit).then(function(e){t(e),c(o.feed)});else{var i={category:o.lastCategory,country:o.lastCountry,filter:o.filter};o.user&&(i.user=o.user._id),i.start=s,i.limit=limit,n[a].call(n,i).then(function(e){return 0==e.length&&"all"!=a&&0==s?(a="all",u()):(t(e),void c(o.feed))})}};u()}}}]).directive("post",["$rootScope","$timeout","identityService","postService","commentService","reactionsService","followService","reportModal",function(e,t,n,o,i,r,s,a){return{restrict:"E",templateUrl:"assets/views/directives/post.htm",scope:{post:"=",user:"=",justone:"="},link:function(c,u,l){c.expandVisible=!1,t(function(){if(!c.justone){var e=u.find(".content")[0];e.scrollHeight-10>e.clientHeight&&(c.expandVisible=!0,c.$apply())}}),angular.element(document.body).on("click",function(){c.post.menu=!1}),s.isFollowing(c.post.author._id).then(function(e){c.post.author.isFollowing=e}),c.follow=function(e){s.follow(e.author._id).then(function(e){c.post.author.isFollowing=e})},c.unfollow=function(e){s.unfollow(e.author._id).then(function(e){c.post.author.isFollowing=e})},c.hide=function(t){o.hide(t._id).then(function(t){c.post.hidden=!0,e.$emit("updateFeedVisibleCount")})},c.unhide=function(t){o.unhide(t._id).then(function(t){c.post.hidden=!1,e.$emit("updateFeedVisibleCount")})},e.$on("muteauthor",function(t,n){c.post.author._id==n&&(c.post.muted=!0,e.$emit("updateFeedVisibleCount"))}),c.mute=function(t){o.mute(t._id).then(function(n){e.$emit("muteauthor",t._id)})},c.block=function(t){n.block(t._id).then(function(t){c.post.blocked=!0,e.$emit("updateFeedVisibleCount")})},c.report=function(e){n.report(e._id).then(function(e){a.activate({$parent:c})})},c.files=[],c.addComment=function(t){if(!c.loading){c.loading=!0;var n=c.files.map(function(e){return e.fileObject}),o={_id:"",author:c.user,createdAt:new Date,dislikes:0,likes:0,post:t._id,text:t.commentText,images:c.files.map(function(e){return e.base64})};t.comments||(t.comments=[]),t.comments.push(o),i.add(t._id,t.commentText,n).then(function(){e.$emit("reloadcomments",t._id),c.loading=!1},function(){c.loading=!1}),t.commentText="",c.files=[]}},c.addImage=function(){if(!c.loading){var e=u[0].querySelector("input[type=file]");angular.element(e).on("change",function(e){e.stopImmediatePropagation();var t=new FileReader,n=e.target.files[0];-1!==["image/jpeg","image/png"].indexOf(n.type)&&(t.addEventListener("load",function(){c.$apply(function(){c.files.push({base64:t.result,fileObject:n}),angular.element(e.target).parent()[0].reset()})}),t.readAsDataURL(n))}),t(function(){e.click(),t.cancel(this)},0)}},c.react=function(t,n,o){var i="react";o&&(i="unreact"),c.post.youdid[n]="react"==i,"like"==n&&c.post.youdid.dislike?c.post.youdid.dislike=!1:"dislike"==n&&c.post.youdid.like&&(c.post.youdid.like=!1),r[i](t._id,n).then(function(n){e.$emit("reloadreactions",t._id)},function(e){console.error("Reaction failed"),console.error(e)})},c.removePost=function(t){o.remove(t._id).then(function(){e.$emit("reloadfeed")},function(){alert("Unable to remove post. Please, try again later.")})}}}}]).directive("postreactions",["$rootScope","reactionsService",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/postreactions.htm",scope:{post:"="},link:function(n,o,i){n.reactions={expert:{likes:0,dislikes:0,shares:0},journalist:{likes:0,dislikes:0,shares:0},user:{likes:0,dislikes:0,shares:0}};var r=function(){t.get(n.post._id).then(function(e){n.post.youdid=e.youdid;var t=e.reactions;t.expert.likes=numeral(t.expert.likes).format("0a").toUpperCase(),t.expert.dislikes=numeral(t.expert.dislikes).format("0a").toUpperCase(),t.expert.shares=numeral(t.expert.shares).format("0a").toUpperCase(),t.journalist.likes=numeral(t.journalist.likes).format("0a").toUpperCase(),t.journalist.dislikes=numeral(t.journalist.dislikes).format("0a").toUpperCase(),t.journalist.shares=numeral(t.journalist.shares).format("0a").toUpperCase(),t.user.likes=numeral(t.user.likes).format("0a").toUpperCase(),t.user.dislikes=numeral(t.user.dislikes).format("0a").toUpperCase(),t.user.shares=numeral(t.user.shares).format("0a").toUpperCase(),n.reactions=t,n.$apply()},function(e){console.error(e)})};r(),e.$on("reloadreactions",function(e,t){t==n.post._id&&r()})}}}]).directive("postcomments",["$rootScope","postService","commentService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/postcomments.htm",scope:{post:"=",nocollapse:"=",user:"="},link:function(o,i,r){o.comments=[],e.$on("reloadcomments",function(e,t){s()}),o.remove=function(e){n.remove(e._id).then(function(t){console.log(t),console.log(t.ok),console.log(t.n),1==t.ok&&1==t.n&&(e.removed=!0)})};var s=function(){t.getComments(o.post._id).then(function(t){for(var n in t){var i=t[n];i.fullText="",i.text.length>500&&(i.fullText=i.text,i.text=i.text.substr(0,500)+"..."),t[n]=i}console.log(t),o.comments=t,o.$parent.commentsCount=o.comments.length,o.post.comments=t,o.$apply(),e.$emit("commentsloaded",o.post._id)})};s()}}}]).directive("commentreactions",["$rootScope","commentReactionsService",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/commentreactions.htm",scope:{comment:"="},link:function(n,o,i){var r=function(){t.get(n.comment._id).then(function(e){n.comment.youdid=e.youdid;var t=e.reactions;n.reactions=t,n.$apply()},function(e){console.error(e)})};r(),e.$on("reloadcommentreactions",function(e,t){t==n.comment._id&&r()}),n.react=function(o,i,r){var s="react";r&&(s="unreact"),n.comment.youdid[i]="react"==s,console.log(n.reactions[i+"s"]),n.reactions[i+"s"]+="react"==s?1:-1,console.log(n.reactions[i+"s"]),"like"==i&&n.comment.youdid.dislike?(n.comment.youdid.dislike=!1,n.reactions.dislikes--):"dislike"==i&&n.comment.youdid.like&&(n.comment.youdid.like=!1,n.reactions.likes--),t[s](o._id,i).then(function(t){e.$emit("reloadcommentreactions",o._id)},function(e){console.log("Reaction failed"),console.log(e)})}}}}]).directive("person",["$rootScope","followService",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/person.htm",scope:{person:"="},link:function(n,o,i){n.person.intro&&n.person.intro.length>110&&(n.person.intro=n.person.intro.substr(0,110)+"..."),angular.element(document.body).on("click",function(){n.person.menu=!1,n.$apply()}),n.person.role=n.person.role[0].toUpperCase()+n.person.role.substr(1),t.isFollowing(n.person._id).then(function(e){n.person.isFollowing=e}),n.toggleFollow=function(o){o.isFollowing?t.unfollow(o._id).then(function(t){n.person.isFollowing=t,e.$emit("update-follow")}):t.follow(o._id).then(function(t){n.person.isFollowing=t,e.$emit("update-follow")})}}}}]).directive("question",["followService","questionsService",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/question.htm",scope:{question:"="},link:function(e,t,n){}}}]).directive("familiarexpert",["$rootScope","followService","postService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/familiar-expert.htm",scope:{person:"=",user:"="},link:function(o,i,r){o.person.role=o.person.role[0].toUpperCase()+o.person.role.substr(1),t.isFollowing(o.person._id).then(function(e){o.person.isFollowing=e}),o.mute=function(e){n.mute(e._id),delete o.person},o.follow=function(n){t.follow(n._id).then(function(t){o.person.isFollowing=t,e.$emit("update-follow")})},o.unfollow=function(n){t.unfollow(n._id).then(function(t){o.person.isFollowing=t,e.$emit("update-follow")})}}}}]).directive("friendrequest",["friendshipService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/friend-request.htm",scope:{user:"=",friendshipRequest:"="},link:function(t,n,o){console.log(t),t.friendshipRequest.user.role=t.friendshipRequest.user.role[0].toUpperCase()+t.friendshipRequest.user.role.substr(1),t.accept=function(n){e.accept(n._id),delete t.friendshipRequest},t.decline=function(n){e.decline(n._id).then(function(e){delete t.friendshipRequest})}}}}]).directive("newquestions",["$rootScope","questionsService","followService",function(e,t,n){return{restrict:"E",templateUrl:"assets/views/directives/new-questions.htm",scope:{user:"="},link:function(o,i,r){o.loading=!0,o.questions=[],o.init=function(){t.get(null,"active",0,3).then(function(e){if(o.loading=!1,o.questions.length>0)for(var t in e){var i=e[t];for(var r in o.questions){var s=o.questions[r];i._id==s._id&&(s.liked=i.liked,s.likes=i.likes)}}else o.questions=e.map(function(e){return e.author.role=e.author.role[0].toUpperCase()+e.author.role.substr(1),e.text.length>100&&(e.text=e.text.substr(0,100)+"..."),e}),async.mapSeries(o.questions,function(e,t){n.isFollowing(e.author._id).then(function(n){e.author.isFollowing=n,t(null,e)})},function(e,t){o.questions=t})})["catch"](function(e){o.loading=!1})},o.init(),e.$on("updateQuestionsCounters",o.init),o.refresh=function(){o.questions=[],o.loading=!0,o.init()},o.follow=function(e){n.follow(e.author._id).then(function(t){e.author.isFollowing=t})},o.like=function(n){t.like(n._id).then(function(t){n.liked=!0,n.likes=t.count,e.$emit("updateQuestionsCounters")})}}}}]).directive("familiarexperts",["familiarExpertsService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/familiar-experts.htm",link:function(t,n,o){t.init=function(){t.users=[],t.familiarExpertsLoading=!0,e.get().then(function(e){t.users=e,t.familiarExpertsLoading=!1})},t.init()}}}]).directive("friendshiprequests",["friendshipService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/friend-requests.htm",link:function(t,n,o){t.init=function(){t.friendshipRequests=[],t.friendshipRequestsLoading=!0,e.pending().then(function(e){t.friendshipRequests=e,t.friendshipRequestsLoading=!1})},t.init()}}}]).directive("topbar",["$rootScope",function(e){return{restrict:"E",templateUrl:"assets/views/directives/topbar.htm",scope:{user:"=",q:"=?"},link:function(t,n,o){t.q||(t.q=""),t.openUserMenu=function(t){t.stopPropagation(),e.$broadcast("open-user-menu")}}}}]).directive("filters",["$rootScope",function(e){return{restrict:"E",templateUrl:"assets/views/directives/filters.htm",link:function(t,n){t.filters=[{title:"Top",filter:"top"},{title:"News",filter:"news"},{title:"Journalist",filter:"journalist"},{title:"Expert",filter:"expert"},{title:"Photos",filter:"photos"}],t.activeFilter="news",t.setFilter=function(n){t.activeFilter=n,e.$emit("feedFilter",n)}}}}]).directive("bigratedavatar",["$timeout","$rootScope",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/big-rated-avatar.htm",scope:{user:"=",onEdit:"="},link:function(t,n,o){"function"==typeof t.onEdit&&(t.editing=!0,t.chooseFile=function(){var o=n[0].querySelector("input[type=file]");angular.element(o).on("change",function(e){e.stopImmediatePropagation(),t.$apply(function(){var n=e.target.files[0];t.onEdit(n)})}),e(function(){o.click(),e.cancel(this)},0)});var i=function(){var e=angular.element(n).find("canvas")[0],o=e.getContext("2d"),i=angular.element(n)[0].children[0].offsetWidth,r=angular.element(n)[0].children[0].offsetHeight;angular.element(n).find("canvas").attr("width",i),angular.element(n).find("canvas").attr("height",r);var s=4,a=(Date.now(),t.user.xpInfo);Date.now();t.level=a.level;var c=(t.user.xp-a.prevLevelXp)/(a.nextLevelXp-a.prevLevelXp)*100;if(t.user.xp){var u=c/100*2+1.5;o.lineWidth=s,o.strokeStyle="#43abe7",o.beginPath(),o.arc(i/2,r/2,i/2-s/2,1.5*Math.PI,u*Math.PI,!1),o.stroke()}};i(),window.onresize=i}}}]).directive("autosuggest",function(){return{restrict:"E",templateUrl:"assets/views/directives/autosuggest.htm",scope:{suggestions:"=",ngModel:"=",viewTitle:"@"},link:function(e,t,n){e.show=!1;var o;e.$watch("ngModel",function(t,n){if(t&&t.title!=n.title&&n.title!=o){e.filteredSuggestions=[];for(var i=0;i<e.suggestions.length;i++){var r=e.suggestions[i];-1!==r.title.toLowerCase().indexOf(t.title.toLowerCase())&&e.filteredSuggestions.push(r)}e.filteredSuggestions=e.filteredSuggestions.slice(0,7),e.show=!0}else e.show=!1},!0),e.setSuggestion=function(t){o=e.ngModel.title,e.ngModel=t,e.show=!1}}}}).directive("lightbox",function(){return{restrict:"A",scope:{ngHref:"="},link:function(e,t,n){var o=window.location.origin+"/"+e.ngHref,i=angular.element(document.body),r=!1,s=new Image;s.src=o,s.onload=function(){s.width<window.innerWidth&&s.height<window.innerHeight&&(r=!0)},t.on("click",function(e){e.preventDefault(),e.stopImmediatePropagation();var t=angular.element('<div class="backdrop"></div>'),n=angular.element('<div class="image"></div>');r?n.addClass("small"):n.removeClass("small"),n.css("backgroundImage","url("+o+")"),t.append(n),i.append(t);var s=function(e){t.remove()};t.on("click",s),i.on("keydown",function(e){27==e.keyCode&&s()})})}}}).directive("pieces",["piecesService",function(e){return{restric:"E",templateUrl:"assets/views/directives/pieces.htm",link:function(t,n,o){e.get().then(function(e){t.pieces=e},function(){})}}}]).directive("profilecard",function(){return{restrict:"E",templateUrl:"assets/views/directives/profilecard.htm",scope:{user:"="},link:function(e,t,n){e.image=e.user.avatar||"/assets/images/avatar_placeholder.png"}}}).directive("followersicon",["$rootScope","$interval","$timeout","followService",function(e,t,n,o){return{restrict:"E",templateUrl:"assets/views/directives/followersicon.htm",scope:{user:"="},link:function(t,i,r){t.count=e.badgeFollowers||0,t.toggleFollow=function(e,t){t.stopImmediatePropagation(),e.isFollowing?o.unfollow(e._id).then(function(t){e.isFollowing=t}):o.follow(e._id).then(function(t){e.isFollowing=t})},angular.element(document.body).on("click",function(){t.dropdownVisible=!1,t.$apply()});var s=function(){async.parallel([function(e){o.followers(t.user._id,0,10,["createdAt","desc"]).then(function(n){n=n.map(function(e){return e.role=e.role[0].toUpperCase()+e.role.substr(1),e}),t.followers=n,e()})},function(n){o.unread().then(function(o){t.count=e.badgeFollowers=o,n()})}],function(){})};t.showDropdown=function(i){i.stopImmediatePropagation(),n(function(){document.body.click(),t.dropdownVisible=!t.dropdownVisible,o.setReadForUser().then(function(){t.count=e.badgeFollowers=0})},10)},s()}}}]).directive("notificationsicon",["$rootScope","$interval","$timeout","notificationService",function(e,t,n,o){return{restrict:"E",templateUrl:"assets/views/directives/notificationsicon.htm",scope:{user:"="},replace:!1,link:function(i,r,s){i.notifications=[],i.count=e.badgeNotifications||0,angular.element(document.body).on("click",function(){i.dropdownVisible=!1,i.$apply()});var a=function(t){o.get().then(function(n){i.count=e.badgeNotifications=n.count,i.notifications=n.notifications,"function"==typeof t&&t()})},c=t(function(){i.dropdownVisible||a()},3e3);r.on("$destroy",function(){t.cancel(c)}),i.showDropdown=function(e){e.stopImmediatePropagation(),n(function(){document.body.click(),i.dropdownVisible=!i.dropdownVisible,o.setReadForUser().then(function(){for(var e in i.notifications)i.notifications[e].read=!0;i.count=0})},10)},a()}}}]).directive("wallpaperblock",["$rootScope","followService","friendshipConfirmModal","friendshipService",function(e,t,n,o){return{restrict:"E",templateUrl:"assets/views/directives/wallpaperblock.htm",scope:{type:"=",user:"=",profile:"="},link:function(i,r,s){i.follow=function(n){t.follow(n._id).then(function(t){i.profile.isFollowing=t,e.$emit("update-follow")})},i.unfollow=function(n){t.unfollow(n._id).then(function(t){i.profile.isFollowing=t,e.$emit("update-follow")})},i.addContact=function(e){n.activate({$parent:i,userID:e})},i.removeContact=function(e){o.remove(e).then(function(e){i.profile.isFriend=e.isFriend},function(e){console.log(e)})}}}}]).directive("profileinfo",["identityService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/profileinfo.htm",scope:{profile:"="},link:function(t,n,o){e.images(t.profile._id).then(function(e){t.images=e})}}}]).directive("search",["identityService","$location",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/search.htm",scope:{q:"="},link:function(n,o,i){n.dropdownVisible=!1,n.loading=!1,angular.element(document.body).on("click",function(){n.dropdownVisible=!1,n.$apply()}),n.multisearch=function(){var t=n.q.trim();return t?(n.loading=!0,void e.multisearch(n.q).then(function(e){e.users=e.users.map(function(e){return e.avatar=e.avatar||"/assets/images/avatar_placeholder.png",e.role=e.role[0].toUpperCase()+e.role.substr(1),e}),n.results=e,n.loading=!1,n.dropdownVisible=!0})):void(n.dropdownVisible=!1)},o.find("form").on("submit",function(e){e.preventDefault(),t.path("/tagsearch/"+n.q),n.$apply()})}}}]).directive("messagesicon",["$interval","messagesService",function(e,t){return{restrict:"E",templateUrl:"assets/views/directives/messagesicon.htm",scope:{q:"="},link:function(n,o){var i=function(){t.unread().then(function(e){n.unreadcount=e.count})},r=e(function(){i()},3e3);o.on("$destroy",function(){e.cancel(r)}),i()}}}]).directive("onlineflag",["identityService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/onlineflag.htm",scope:{profile:"="},link:function(t){t.loaded=!1,e.isOnline(t.profile._id).then(function(e){t.isOnline=e,t.loaded=!0})}}}]).directive("photos",["identityService",function(e){return{restrict:"E",templateUrl:"assets/views/directives/photos.htm",scope:{images:"="},link:function(e){}}}]),angular.module("er.filters",[]).filter("tags",function(){return function(e){return e=e||"",e.replace(/(<br>|<q>|<\/q>|^|\s)#([a-z]+[a-z0-9]+)/gim,function(e,t,n,o,i){return t+'<a href="#!/tagsearch/%23'+n+'" class="text-tag">#'+n+"</a>"})}}).filter("people",function(){return function(e){return e=e||"",e.replace(/(<br>|<q>|<\/q>|^|\s)@([a-z]+[a-z0-9]+)/gim,'$1<a href="#!/tagsearch/@$2" class="text-people">@$2</a>')}}).filter("categories",function(){return function(e){return e=e||"",e.replace(/(<br>|<q>|<\/q>|^|\s)\$([a-z]+[a-z0-9]+)/gim,'$1<a href="#!/tagsearch/$$$2" class="text-category">$$$2</a>')}}).filter("textLinks",["$filter",function(e){return function(t){return t=t||"",t=e("tags")(t),t=e("people")(t),t=e("categories")(t)}}]).filter("encodeuri",function(){return function(e){return encodeURIComponent(e)}}).filter("embedvideos",["$sce",function(e){var t=new RegExp("https?:&#47;&#47;(www.)?youtu.?be(.com&#47;watch\\?v=|&#47;)([a-zA-Z0-9_-]+)","i"),n=new RegExp("https?:&#47;&#47;(www.)?vimeo.com&#47;([0-9]+)","i");return function(o){return o=o.replace(t,'<iframe width="100%" height="285" src="//www.youtube.com/embed/$3" frameborder="0" allowfullscreen></iframe>'),o=o.replace(n,'<iframe width="100%" height="285" src="//player.vimeo.com/video/$2" frameborder="0" allowfullscreen></iframe>'),e.trustAsHtml(o)}}]).filter("url",["$sce",function(e){var t="(?:(?:[a-z]+:)?(&#47;&#47;|//))",n="(?:\\S+(?::\\S*)?@)?",o="(?:[0-9]{,3}.[0-9]{,3}.[0-9]{,3}.[0-9]{,3})",i="(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)",r="(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*",s="(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))\\.?",a="(?::\\d{2,5})?",c='(?:[(&#47;/)?#][^\\s"]*)?',u="(^|\\s+|<br>)((?:"+t+"|www\\.)"+n+"(?:localhost|"+o+"|"+i+r+s+")"+a+c+")",l=new RegExp(u,"mig");return function(t){return t=t.toString(),t=t.replace(l,'<a target="_blank" href="$2">$2</a>'),e.trustAsHtml(t)}}]),angular.module("er.modals",[]).factory("confirmPhoneModal",["btfModal",function(e){return e({controller:"confirmPhoneModalController",controllerAs:"modal",templateUrl:"assets/views/modals/confirm-account.htm"})}]).controller("confirmPhoneModalController",["$scope","$parent","$interval","phone","callback","confirmPhoneModal","verifyPhoneService","verifyPhoneCodeService",function(e,t,n,o,i,r,s,a){e.phone=o,e.maxResendTimerValue=30,e.errormessage="";var c=function(){e.resendTimer=e.maxResendTimerValue,e.errormessage="",e.ready=!1,e.loading=!0,s(o).then(function(){e.ready=!0,e.loading=!1,n(function(){e.resendTimer--},1e3,e.maxResendTimerValue)},function(t){e.ready=!0,e.loading=!1,e.errormessage=t,console.log(t)})};c(),e.close=function(){r.deactivate(),i(!1)},e.resend=function(){0==e.resendTimer&&c()},e.confirm=function(){return e.code?(e.loading=!0,void a(o,e.code).then(function(t){e.loading=!1,r.deactivate(),i(!0),console.log(t)},function(t){e.loading=!1,e.codeError=!0,console.log(t)})):e.codeError=!0}}]).factory("confirmAccountModal",["btfModal",function(e){return e({controller:"confirmAccountModalController",controllerAs:"modal",templateUrl:"assets/views/modals/confirm-account.htm"})}]).controller("confirmAccountModalController",["$scope","$parent","$interval","phone","confirmAccountModal","verifyPhoneService","verifyPhoneCodeService",function(e,t,n,o,i,r,s){e.phone=o,e.maxResendTimerValue=30;var a=function(){e.resendTimer=e.maxResendTimerValue,e.ready=!1,e.loading=!0,r(o).then(function(){e.ready=!0,e.loading=!1,n(function(){e.resendTimer--},1e3,e.maxResendTimerValue)})};a(),e.close=function(){i.deactivate(),t.doneSignup(!1)},e.resend=function(){0==e.resendTimer&&a()},e.confirm=function(){return e.code?(e.loading=!0,void s(o,e.code).then(function(n){e.loading=!1,i.deactivate(),t.doneSignup(!0),console.log(n)},function(t){e.loading=!1,e.codeError=!0,console.log(t)})):e.codeError=!0}}]).factory("forgotPasswordModal",["btfModal",function(e){return e({controller:"forgotPasswordModalController",controllerAs:"modal",templateUrl:"assets/views/modals/forgot-password.htm"})}]).controller("forgotPasswordModalController",["$scope","$parent","forgotPasswordModal","forgotPasswordService",function(e,t,n,o){e.close=n.deactivate,e.confirm=function(){return e.emailError=!1,e.email?(e.loading=!0,void o(e.email).then(function(t){e.loading=!1,e.sent=!0},function(t){e.loading=!1,e.error=t})):e.emailError=!0}}]).factory("findMyAccountModal",["btfModal",function(e){return e({controller:"findMyAccountModalController",controllerAs:"modal",templateUrl:"assets/views/modals/find-my-account.htm"})}]).controller("findMyAccountModalController",["$scope","$parent","$location","findMyAccountModal","findAccountRequestService","findAccountSigninService",function(e,t,n,o,i,r){e.close=o.deactivate,e.confirm=function(){return e.error="",e.inputError=!1,e.input?(e.requestLoading=!0,void i(e.input).then(function(t){e.requestLoading=!1,e.codeSent=!0},function(t){e.requestLoading=!1,e.error=t,console.error(t)})):e.inputError=!0},e.signIn=function(){return e.codeValidationError="",e.codeError=!1,e.code?(e.codeLoading=!0,void r(e.code).then(function(t){e.codeLoading=!1,n.url("/");try{window.localStorage.satellizer_token=t.token}catch(i){console.error("localStorage is not supported",i)}o.deactivate()},function(t){e.codeLoading=!1,e.codeValidationError=t})):e.codeError=!0}}]).factory("reportModal",["btfModal",function(e){return e({controller:"reportModalController",controllerAs:"modal",templateUrl:"assets/views/modals/reported.htm"})}]).controller("reportModalController",["$scope","$parent","reportModal",function(e,t,n){e.close=n.deactivate}]).factory("friendshipConfirmModal",["btfModal",function(e){return e({controller:"friendshipConfirmModalController",controllerAs:"modal",templateUrl:"assets/views/modals/friendship-confirm.htm"})}]).controller("friendshipConfirmModalController",["$scope","$parent","userID","friendshipConfirmModal","friendshipService",function(e,t,n,o,i){e.close=o.deactivate,e.validatePhone=function(e){var t=/^\+([0-9]{8,15})$/;return t.test(e)},e.confirm=function(){return e.phoneError=!1,e.phone&&e.validatePhone(e.phone)?(e.loading=!0,void i.add(n,e.phone).then(function(n){e.loading=!1,e.added=!0,t.profile.isFriend=n.isFriend},function(t){e.loading=!1,e.error="Unable to add user to friends list"})):e.phoneError=!0}}]);var __s=function(e,t,n,o,i){n=n.toUpperCase();var r={method:n,url:o,headers:{Authorization:"Bearer "+t.get("token")}};return-1===["GET","DELETE"].indexOf(n)?r.data=i:r.params=i,e(r).then(function(e){return e.data})};angular.module("er.services",[]).factory("findAccountRequestService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/findaccount/request",{value:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("findAccountSigninService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/findaccount/signin",{code:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("forgotPasswordService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/forgotpassword",{email:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("checkPasswordTokenService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/forgotpassword/validate",{token:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("resetPasswordService",["$http","$q",function(e,t){return function(n,o){var i=t.defer();return e.post("/auth/resetpassword",{token:n,newpassword:o}).then(function(e){i.resolve(e.data)},function(e){i.reject(e.data.message)}),i.promise}}]).factory("validateEmailService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/signup/validate/email",{email:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("validatePhoneService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/signup/validate/phone",{phone:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("verifyPhoneService",["$http","$q",function(e,t){return function(n){var o=t.defer();return e.post("/auth/signup/verify/phone",{phone:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise}}]).factory("verifyPhoneCodeService",["$http","$q",function(e,t){return function(n,o){var i=t.defer();return e.post("/auth/signup/verifycode/phone",{phone:n,code:o}).then(function(e){i.resolve(e.data)},function(e){i.reject(e.data.message)}),i.promise}}]).factory("countriesListService",["$http","$q",function(e,t){return function(){var n=t.defer();return e.get("/static/countries").then(function(e){n.resolve(e.data)}),n.promise}}]).factory("fieldsListService",["$http","$cookies",function(e,t){return{get:function(n){var o={};return n&&(o.country=n),__s(e,t,"get","/static/categories",o)},search:function(n){var o={};return n&&(o.country=n),__s(e,t,"get","/static/categories/search",o)},getForUser:function(n){var o={};return n&&(o.country=n),__s(e,t,"get","/user/categories",o)}}}]).factory("updateProfileService",["$http","$cookies",function(e,t){return function(n,o,i,r,s){return new Promise(function(a,c){e({method:"POST",url:"/user/profile/edit/profile",data:{token:t.get("token"),contact:n,experience:o,intro:i,name:r,title:s}}).success(function(e){a(e)}).error(function(e,t){c(e)})})}}]).factory("identityService",["$http","$timeout","$cookies","$auth","$q","$rootScope",function(e,t,n,o,i,r){var s=void 0;return{otherCache:{},getOther:function(t){return __s(e,n,"get","/user",{id:t}).then(function(e){var t=e;return t.color=t.color||"bronze",t.likes=t.likes||0,t.xp=t.xp||0,t.dislikes=t.dislikes||0,t.reactions=t.reactions||0,
t.followers=t.followers||0,t.following=t.following||0,t.avatar=t.avatar||"/assets/images/avatar_placeholder.png",t.role&&(t.role=t.role.charAt(0).toUpperCase()+t.role.slice(1)),t.contact=t.contact||{email:"",phone:"",skype:"",linkedin:"",fb:""},t},function(e,t){return e})},_user:{},get:function(t){var r=i.defer();return!s||void 0!==t&&t!==!1?__s(e,n,"get","/me"+(t?"?x="+Math.random():"")).then(function(e){var t=e;return t.rating=t.rating||1,t.color=t.color||"bronze",t.xp=t.xp||0,t.followers=t.followers||0,t.following=t.following||0,t.avatar=t.avatar||"/assets/images/avatar_placeholder.png",t.role&&(t.role=t.role.charAt(0).toUpperCase()+t.role.slice(1)),t.contact=t.contact||{email:"",phone:"",skype:"",linkedin:"",fb:""},s=t,n.put("token",o.getToken()),r.resolve(t),t}):(r.resolve(s),r.promise)},clean:function(){s=void 0,this.otherCache={}},updateSettings:function(t){return __s(e,n,"post","/user/profile/edit/settings",t)},isPasswordValid:function(t){return __s(e,n,"post","/user/profile/settings/isPasswordValid",{password:t}).then(function(e){return e.valid},function(e){return e})},updatePassword:function(t,o){return __s(e,n,"post","/user/profile/settings/setPassword",{oldPassword:t,newPassword:o})},disconnectSocial:function(t){return __s(e,n,"post","/user/profile/settings/disconnectsocial",{provider:t})},updateNotifications:function(t){return __s(e,n,"post","/user/profile/settings/notifications",t)},mutedAuthors:function(){return __s(e,n,"get","/user/mutedauthors")},block:function(t){return __s(e,n,"post","/user/block",{user:t})},unblock:function(t){return __s(e,n,"post","/user/unblock",{user:t})},report:function(t){return __s(e,n,"post","/user/report",{article:t})},images:function(t){return __s(e,n,"get","/user/images",{user:t})},multisearch:function(t){return __s(e,n,"get","/user/multisearch",{q:t})},searchusers:function(t,o,i,r){return __s(e,n,"get","/user/searchusers",{q:t,role:o,start:i,limit:r})},invite:function(t){return __s(e,n,"post","/user/invite/"+t)},isOnline:function(t){return __s(e,n,"get","/user/isonline",{user:t})},images:function(t){return __s(e,n,"get","/user/images",{user:t})}}}]).factory("uploadAvatarService",["$http","$cookies",function(e,t){return function(n){return new Promise(function(o,i){var r=new FormData;r.append("file",n),r.append("token",t.get("token")),e({method:"POST",url:"/user/profile/edit/avatar",headers:{"Content-Type":void 0},data:r}).success(function(e){o(e)}).error(function(e,t){i(e)})})}}]).factory("uploadWallpaperService",["$http","$cookies",function(e,t){return function(n){return new Promise(function(o,i){var r=new FormData;r.append("file",n),r.append("token",t.get("token")),e({method:"POST",url:"/user/profile/edit/wallpaper",headers:{"Content-Type":void 0},data:r}).success(function(e){o(e)}).error(function(e,t){i(e)})})}}]).factory("certificatesService",["$http","$cookies",function(e,t){return{add:function(n){return new Promise(function(o,i){var r=new FormData;r.append("token",t.get("token")),r.append("file",n),e({method:"POST",url:"/user/profile/edit/addcertificate",headers:{"Content-Type":void 0},data:r}).success(function(e){o(e)}).error(function(e,t){i(e)})})},remove:function(n){return new Promise(function(o,i){e({method:"POST",url:"/user/profile/edit/removecertificate",data:{filename:n.filename,token:t.get("token")}}).success(o).error(function(e,t){i(e)})})}}}]).factory("downloadsService",["$http","$cookies",function(e,t){return{add:function(n){return new Promise(function(o,i){var r=new FormData;r.append("token",t.get("token")),r.append("file",n),e({method:"POST",url:"/user/profile/edit/adddownload",headers:{"Content-Type":void 0},data:r}).success(function(e){o(e)}).error(function(e,t){i(e)})})},remove:function(n){return new Promise(function(o,i){e({method:"POST",url:"/user/profile/edit/removedownload",data:{filename:n.filename,token:t.get("token")}}).success(o).error(function(e,t){i(e)})})}}}]).factory("feedService",["$sce","$http","$cookies",function(e,t,n){return{all:function(e){return __s(t,n,"get","/article/all",e)},search:function(e){return __s(t,n,"get","/article/search",e)},byUser:function(e,o,i){return __s(t,n,"get","/article/byuser",{user:e,start:o,limit:i})},my:function(){return __s(t,n,"get","/article/my")},feed:function(e,o,i){var r={};return i&&(r.userId=i),e&&(r.category=e),o&&(r.country=o),__s(t,n,"get","/article/feed?r="+Math.random(),r)},reacted:function(e,o,i,r){return __s(t,n,"get","/article/feed/"+o,{user:e,start:i,limit:r})}}}]).factory("postService",["$http","$cookies","$timeout",function(e,t,n){return{get:function(n){return __s(e,t,"get","/article/one",{id:n})},create:function(n,o){return new Promise(function(i,r){var s={Authorization:t.get("token")};if(o.length>0){var a=new FormData;a.append("text",n);for(var c in o)a.append("files",o[c]);s["Content-Type"]=void 0}else a={text:n};e({method:"POST",url:"/article/create",headers:s,uploadEventHandlers:{progress:function(e){}},data:a}).success(function(e){i(e)}).error(function(e,t){r(e)})})},remove:function(n){return __s(e,t,"post","/article/remove",{article:n})},queue:[],delay:1e3,timer:void 0,getComments:function(o){var i,r,s=new Promise(function(e,t){i=e,r=t}).then(function(e){return e},function(e,t){return e});return this.queue.push({postId:o,promise:s,resolve:i,reject:r}),n.cancel(this.timer),this.timer=n(function(n){var o=[];for(var i in n.queue){var r=n.queue[i];o.push(r.postId)}return __s(e,t,"get","/article/comment/get/few",{postIds:o.join(",")}).then(function(e){var t=e;for(var o in t){var i=t[o];for(var r in n.queue)n.queue[r].postId==o&&n.queue[r].resolve(i)}},function(e,t){return e})},this.delay,!1,this),s},getCommentsImmediate:function(n){return __s(e,t,"get","/article/comment/get",{postId:n})},hide:function(n){return __s(e,t,"post","/article/hide",{article:n})},unhide:function(n){return __s(e,t,"post","/article/unhide",{article:n})},mute:function(n){return __s(e,t,"post","/article/mute",{author:n})},unmute:function(n){return __s(e,t,"post","/article/unmute",{author:n})}}}]).factory("commentService",["$http","$cookies",function(e,t){return{add:function(n,o,i){var r={Authorization:t.get("token")};if(i.length>0){var s=new FormData;s.append("postId",n),s.append("text",o);for(var a in i)s.append("files",i[a]);r["Content-Type"]=void 0}else var s={postId:n,text:o};return e({method:"POST",url:"/article/comment/add",headers:r,data:s}).then(function(e){return e},function(e,t){return e})},remove:function(n){return __s(e,t,"post","/article/comment/remove",{commentId:n})}}}]).factory("reactionsService",["$http","$cookies","$timeout",function(e,t,n){return{queue:[],delay:500,timer:void 0,get:function(o){var i,r,s=new Promise(function(e,t){i=e,r=t}).then(function(e){return e},function(e,t){return e});return this.queue.push({postId:o,promise:s,resolve:i,reject:r}),n.cancel(this.timer),this.timer=n(function(n){var o=[];for(var i in n.queue){var r=n.queue[i];o.push(r.postId)}return __s(e,t,"get","/article/reactions/few",{postIds:o.join(",")}).then(function(e){for(var t in e){var o=e[t];for(var i in n.queue)n.queue[i].postId==t&&n.queue[i].resolve(o)}},function(e,t){return e})},this.delay,!1,this),s},getImmediate:function(n){return __s(e,t,"get","/article/reactions",{post:n})},react:function(n,o){return __s(e,t,"post","/article/react",{post:n,type:o})},unreact:function(n,o){return __s(e,t,"delete","/article/react",{post:n,type:o})}}}]).factory("followService",["$http","$cookies","identityService",function(e,t,n){return{isFollowing:function(n){return __s(e,t,"get","/follow/isFollowing",{following:n}).then(function(e){return e.isFollowing},function(e,t){return e})},follow:function(n){return __s(e,t,"post","/follow/follow",{following:n}).then(function(e){return e.isFollowing},function(e,t){return e})},unfollow:function(n){return __s(e,t,"post","/follow/unfollow",{following:n}).then(function(e){return e.isFollowing},function(e,t){return e})},following:function(n,o,i,r){return r&&(r=r.join("|")),__s(e,t,"get","/follow/following",{follower:n,skip:o,limit:i,sort:r}).then(function(e){return e.map(function(e){return e.following})},function(e,t){return e})},followers:function(n,o,i,r){return r&&(r=r.join("|")),__s(e,t,"get","/follow/followers",{following:n,skip:o,limit:i,sort:r}).then(function(e){return e.map(function(e){var t=e.follower;return Object.assign(t,{isFollowing:e.isFollowing}),t})},function(e,t){return e})},unread:function(){return __s(e,t,"get","/follow/unread").then(function(e){return e.count},function(e,t){return e})},setReadForUser:function(){return __s(e,t,"post","/follow/setreadall")}}}]).factory("piecesService",["$http","$cookies",function(e,t){return{get:function(){return __s(e,t,"get","/article/pieces")}}}]).factory("commentReactionsService",["$http","$cookies","$timeout",function(e,t,n){return{queue:[],delay:500,timer:void 0,get:function(o){var i,r,s=new Promise(function(e,t){i=e,r=t}).then(function(e){return e},function(e,t){return e});return this.queue.push({commentId:o,promise:s,resolve:i,reject:r}),n.cancel(this.timer),this.timer=n(function(n){var o=[];for(var i in n.queue){var r=n.queue[i];o.push(r.commentId)}return __s(e,t,"get","/article/comment/reactions/few",{commentIds:o.join(",")}).then(function(e){for(var t in e){var o=e[t];for(var i in n.queue)n.queue[i].commentId==t&&n.queue[i].resolve(o)}},function(e,t){return e})},this.delay,!1,this),s},getImmediate:function(n){return __s(e,t,"get","/article/comment/reactions",{comment:commentId})},react:function(n,o){return __s(e,t,"post","/article/comment/react",{comment:n,type:o})},unreact:function(n,o){return __s(e,t,"delete","/article/comment/react",{comment:n,type:o})}}}]).factory("familiarExpertsService",["$http","$cookies",function(e,t){return{get:function(){return __s(e,t,"get","/user/familiarexperts")}}}]).factory("categoriesService",["$http","$q",function(e,t){return function(e){var n=t.defer(),o=[{id:1,title:"World News",count:353478392},{id:2,title:"Canada News",count:12478392},{id:3,title:"Buzz News",count:4478392},{id:4,title:"Science",count:2478392},{id:4,title:"Science",count:2478392},{id:5,title:"Business",count:532952},{id:6,title:"Health",count:422321},{id:7,title:"Technology",count:352210},{id:8,title:"Sport",count:24990},{id:9,title:"Entertainment",count:1224}];return n.resolve(o),n.promise}}]).factory("groupedCountriesService",["$http","$cookies","$q",function(e,t,n){return{get:function(n){return __s(e,t,"get","/static/countries/grouped",{category:n})}}}]).factory("notificationService",["$http","$cookies",function(e,t){return{list:[],get:function(){var n=this;return __s(e,t,"get","/n/get?r="+Math.random()).then(function(e){return n.list=e,e},function(e,t){return e})},setReadForUser:function(){return __s(e,t,"post","/n/setreadall")}}}]).factory("questionsService",["$http","$cookies",function(e,t){return{add:function(n,o){return __s(e,t,"post","/questions/create",{recipient:n,text:o})},cancel:function(n){return __s(e,t,"post","/questions/settype",{question:n,type:"cancelled"})},list:[],get:function(n,o,i,r){var s=this,a={};return n&&(a.user=n),o&&(a.type=o),i&&(a.skip=i),r&&(a.limit=r),__s(e,t,"get","/questions/all",a).then(function(e){return s.list=e,e})},reply:function(n,o){return __s(e,t,"post","/questions/reply",{question:n,text:o})},like:function(n){return __s(e,t,"post","/questions/like",{question:n})}}}]).factory("messagesService",["$http","$cookies",function(e,t){return{getConversations:function(){return __s(e,t,"get","/chat/conversations")},getConversation:function(n,o,i){return __s(e,t,"get","/chat/conversation",{user:n,skip:o,limit:i})},sendMessage:function(n,o,i){var r={Authorization:t.get("token")};if(i.length>0){var s=new FormData;s.append("text",o),s.append("to",n);for(var a in i)s.append("files",i[a]);r["Content-Type"]=void 0}else s={to:n,text:o};return e({method:"POST",url:"/chat/send",headers:r,uploadEventHandlers:{progress:function(e){}},data:s}).then(function(e){return e.data})},setRead:function(n){return __s(e,t,"post","/chat/setread",{ids:n})},hide:function(n){return __s(e,t,"post","/chat/hide",{ids:n})},unread:function(){return __s(e,t,"get","/chat/unreadcount")}}}]).factory("friendshipService",["$http","$q","$cookies",function(e,t,n){return{add:function(n,o){var i=t.defer();return e.post("/friendship/add",{id:n,phone:o}).then(function(e){i.resolve(e.data)},function(e){i.reject(e.data.message)}),i.promise},remove:function(n){var o=t.defer();return e.post("/friendship/remove",{id:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise},pending:function(){console.log("pending requests called");var n=t.defer();return e.get("/friendship/pending",{limit:3}).then(function(e){n.resolve(e.data)},function(e){n.reject(e.data.message)}),n.promise},accept:function(n){var o=t.defer();return e.post("/friendship/accept",{id:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise},decline:function(n){var o=t.defer();return e.post("/friendship/decline",{id:n}).then(function(e){o.resolve(e.data)},function(e){o.reject(e.data.message)}),o.promise},isFriend:function(t){return __s(e,n,"get","/friendship/isFriend",{id:t}).then(function(e){return e.isFriend},function(e,t){return e})}}}]),angular.module("er.validators",[]).directive("email");
//# sourceMappingURL=app.js.map